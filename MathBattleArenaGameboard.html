<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Battle Arena</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
	
	<script>
	window.MathJax = {
	  tex: {
		inlineMath: [['$', '$'], ['\\(', '\\)']],
		displayMath: []   // <---- disables display mode entirely
	  },
	  svg: {
		fontCache: 'global'
	  }
	};
	</script>

	<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
	
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #e6e6e6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .game-container {
            max-width: 900px;
            width: 100%;
            background: #161b22;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 1.5rem;
            border: 3px solid #30363d;
        }
        .health-bar-bg {
            background-color: #30363d;
            border-radius: 9999px;
            overflow: hidden;
            border: 2px solid #555;
            height: 20px;
        }
        .health-fill {
            transition: width 0.5s ease-in-out, background-color 0.5s;
            height: 100%;
            border-radius: 9999px;
        }
        /* FIXED HEIGHT CONTENT AREA - Prevents scrolling */
        .content-area-fixed {
            min-height: 220px; /* Fixed height for message, timer, question, and input */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .message-box {
            min-height: 50px;
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            text-align: center;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .attack-btn {
            background: linear-gradient(180deg, #2b6cb0, #2c5282);
            transition: all 0.2s;
            box-shadow: 0 4px 0 #1c3d5a;
        }
        .attack-btn:hover {
            background: linear-gradient(180deg, #3182ce, #2b6cb0);
            box-shadow: 0 2px 0 #1c3d5a;
            transform: translateY(2px);
        }
        .attack-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .character-icon {
            font-size: 5rem;
            transition: transform 0.1s, filter 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 5rem;
        }
        /* Item Card Styling */
        .item-card {
            background-color: #21262d;
            border: 2px solid #30363d;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .item-card:hover {
            border-color: #4f46e5;
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.5);
        }

        /* Leaderboard styling */
        .leaderboard-table {
            border-collapse: collapse;
            width: 100%;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #30363d;
            text-align: left;
        }
        .leaderboard-table th {
            background-color: #21262d;
            color: #90cdf4;
            font-weight: bold;
        }
        .leaderboard-table tr:hover {
            background-color: #1a2027;
        }
		
		mjx-container {
			display: inline-flex !important;
			align-items: center;
			justify-content: center;
			margin: 10 !important;
			padding: 10 !important;
			font-size: 1em !important;
		}

		mjx-container[jax="SVG"] {
			margin: 0 !important;
			padding: 0 !important;
		}
		
		#questionDisplayEl {
			white-space: nowrap;
		}
        
		@keyframes heroAttack {
			0%   { transform: translateX(0) rotate(0deg); }
			30%  { transform: translateX(25px) rotate(10deg) scale(1.1); }
			60%  { transform: translateX(-5px) rotate(-5deg) scale(1.05); }
			100% { transform: translateX(0) rotate(0deg) scale(1); }
		}

		@keyframes monsterDamage {
			0%   { transform: scale(1); }
			30%  { transform: scale(1.2) rotate(5deg); }
			60%  { transform: scale(0.95) rotate(-3deg); }
			100% { transform: scale(1); }
		}

		@keyframes monsterAttack {
			0%   { transform: translateX(0) rotate(0deg); }
			25%  { transform: translateX(-25px) rotate(-10deg) scale(1.1); }
			50%  { transform: translateX(10px) rotate(5deg) scale(1.05); }
			75%  { transform: translateX(-5px) rotate(-3deg); }
			100% { transform: translateX(0) rotate(0deg) scale(1); }
		}

		@keyframes heroDamage {
			0%   { transform: scale(1); }
			25%  { transform: scale(1.2) rotate(-5deg); }
			50%  { transform: scale(0.95) rotate(3deg); }
			75%  { transform: scale(1.1) rotate(-2deg); }
			100% { transform: scale(1); }
		}

		@keyframes superFlash {
			0%   { background-color: rgba(255,255,255,0); }
			25%  { background-color: rgba(255,255,255,0.6); }
			50%  { background-color: rgba(255,255,255,0.8); }
			75%  { background-color: rgba(255,255,255,0.6); }
			100% { background-color: rgba(255,255,255,0); }
		}

		@keyframes superAttackShake {
			0%   { transform: translateX(0); }
			10%  { transform: translateX(-8px) rotate(-2deg); }
			20%  { transform: translateX(8px) rotate(2deg); }
			30%  { transform: translateX(-6px) rotate(-1deg); }
			40%  { transform: translateX(6px) rotate(1deg); }
			50%  { transform: translateX(-4px) rotate(-1deg); }
			60%  { transform: translateX(4px) rotate(1deg); }
			70%  { transform: translateX(-2px) rotate(0deg); }
			80%  { transform: translateX(2px) rotate(0deg); }
			100% { transform: translateX(0); }
		}
		
		.hero-attack-effect { animation: heroAttack 0.5s ease-out forwards; }
		.monster-damage-effect { animation: monsterDamage 0.5s ease-out forwards; }
		.monster-attack-effect { animation: monsterAttack 0.5s ease-in-out forwards; }
		.hero-damage-effect { animation: heroDamage 0.5s ease-in-out forwards; }
		.super-flash-effect { animation: superFlash 0.6s ease-in-out forwards; }
		.shake-effect { animation: superAttackShake 0.6s ease-in-out forwards; }

    </style>
</head>
<body>

<div id="gameApp" class="game-container">
    <h1 class="text-3xl font-black text-center mb-6 text-yellow-300">‚öîÔ∏è Math Battle Arena üõ°Ô∏è</h1>

    <!-- Configuration Panel -->
    <div id="configPanel" class="bg-gray-800 p-4 rounded-lg mb-6 shadow-xl">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <!-- Level Select -->
            <div class="mb-4 sm:mb-0">
                <label for="level" class="text-lg font-semibold text-gray-300 mr-3">Choose Level:</label>
                <select id="level" class="p-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                    <option value="1">G1 (Addition/Subtraction)</option>
                    <option value="3">G3 (Multiplication/Division)</option>
                    <option value="6">G6 (Fractions/Decimals)</option>
                    <option value="9">G9 (Algebra/Equations)</option>
                    <option value="12">G12 (Trigonometry/Calculus)</option>
                </select>
            </div>
            <!-- Status Indicators -->
            <div class="flex space-x-6 text-center">
                <div class="text-lg font-bold text-yellow-400">
                    Battle: <span id="battleCount">1</span> / 5
                </div>
                <div class="text-lg font-bold text-green-400">
                    Streak: <span id="streakCount">0</span> / 3
                </div>
            </div>
        </div>

		<div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
			<!-- Hero Name Input -->
			<div class="w-full sm:w-1/2">
				<label for="heroNameInput" class="block text-sm font-medium text-gray-300">Your Hero Name:</label>
				<input type="text" id="heroNameInput" value="Math Warrior"
					   class="mt-1 block w-full p-2 rounded-lg bg-gray-700 border border-gray-600 text-white"
					   maxlength="15">
			</div>

			<!-- Character Select -->
			<div class="w-full sm:w-1/2">
				<label for="heroClassSelect" class="block text-sm font-medium text-gray-300">Choose Class:</label>
				<div class="flex items-center mt-1 space-x-2">
					<select id="heroClassSelect" class="flex-1 p-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
						<option value="0">‚öîÔ∏è Balanced Blade</option>
						<option value="1">üõ°Ô∏è Tanky Titan</option>
						<option value="2">üßô Speedy Sorcerer</option>
					</select>

					<button id="heroInfoBtn" class="flex-none p-1 rounded-full hover:bg-gray-600 text-yellow-400 hover:text-yellow-300" title="Click for hero info">
						‚ìò
					</button>
				</div>
			</div>
			
			<!-- Hero Info Modal (hidden by default) -->
			<div id="heroInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
				<div class="bg-gray-800 p-8 rounded-lg w-11/12 max-w-3xl relative text-white shadow-xl">
					<h2 id="heroInfoTitle" class="text-2xl font-bold mb-4"></h2>
					<p id="heroInfoDesc" class="mb-6 leading-relaxed"></p>
					<ul id="heroInfoStats" class="list-disc ml-6 mb-6 space-y-1"></ul>
					<button id="heroInfoClose" class="absolute top-4 right-4 text-red-400 hover:text-red-300 font-bold text-xl">‚úñ</button>
				</div>
			</div>
        </div>
    </div>

    <!-- Battle Area -->
    <div id="battleArea" class="block">
        <div class="flex justify-between items-end mb-4">
            <!-- Hero Section -->
            <div id="heroVisualContainer" class="flex flex-col items-center">
                <div id="heroVisual" class="character-icon hero-icon">
                    <span id="heroEmoji">‚öîÔ∏è</span>
                </div>
                <p id="heroNameDisplay" class="text-xl font-bold mt-2 text-white">Math Warrior</p>
                <div class="health-bar-bg w-full min-w-[150px] mt-2">
                    <div id="heroHealth" class="health-fill bg-green-500" style="width: 100%;"></div>
                </div>
                <p class="text-sm mt-1 text-green-400">Max HP: <span id="heroMaxHPDisplay">100</span></p>
            </div>

            <!-- Vs. Text -->
            <div class="text-4xl font-black text-gray-500 mx-4 hidden sm:block">VS</div>

            <!-- Monster Section -->
            <div id="monsterVisualContainer" class="flex flex-col items-center">
                <div id="monsterVisual" class="character-icon monster-icon">
                    <span id="monsterEmoji">üëπ</span>
                </div>
                <p id="monsterName" class="text-xl font-bold mt-2 text-white">The Error Beast</p>
                <div class="health-bar-bg w-full min-w-[150px] mt-2">
                    <div id="monsterHealth" class="health-fill bg-red-500" style="width: 100%;"></div>
                </div>
                <p class="text-sm mt-1 text-red-400">Monster HP: <span id="monsterCurrentHPDisplay">100</span></p>
            </div>
        </div>
        
        <!-- Game Status, Question, and Input (FIXED HEIGHT) -->
        <div class="content-area-fixed">
            <!-- Timer Display -->
            <div id="timerBox" class="hidden timer-box text-3xl font-extrabold p-1 rounded-lg bg-red-800 border-2 border-red-500 text-yellow-300">
                <span id="timerTitle">Time Left:</span> <span id="timerDisplay">20</span>s
            </div>

            <!-- Message Box -->
            <div id="messageBox" class="message-box">
                Enter your hero name, choose your class, select a level, and press 'Start Battle' to begin!
            </div>
            
            <!-- Question and Answer Input -->
            <div id="gamePlayArea" class="hidden">
                <div class="text-center">
                    <div id="questionDisplay" class="text-xl font-extrabold text-white mb-3 inline-flex justify-center w-full"></div>
                    <input type="text" id="answerInput" placeholder="Your Answer"
                           class="p-3 text-xl rounded-lg bg-gray-700 border border-gray-600 text-white w-full sm:w-1/2 focus:ring-blue-500 focus:border-blue-500 text-center"
                           onkeydown="if(event.key === 'Enter') checkAnswer()">
                </div>
                <div class="flex justify-center mt-4">
                    <button onclick="checkAnswer()" id="submitButton" class="attack-btn text-white font-bold py-2 px-6 rounded-xl text-md uppercase tracking-wider">
                        Submit Answer (Attack!)
                    </button>
                    <button onclick="skipQuestion()" id="skipButton" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-xl text-md uppercase tracking-wider ml-4">
                        Skip (1 Use)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reward Screen -->
    <div id="rewardArea" class="hidden mt-8 p-6 bg-gray-900 rounded-lg shadow-2xl">
        <h2 class="text-3xl font-black text-center text-yellow-400 mb-6">üèÜ Battle Won! Choose Your Reward üèÜ</h2>
        <div id="itemSelectionArea" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Item cards will be generated here -->
        </div>
    </div>
    
    <!-- Leaderboard Screen -->
    <div id="leaderboardArea" class="hidden mt-8 p-6 bg-gray-900 rounded-lg shadow-2xl">
        <h2 class="text-3xl font-black text-center text-green-400 mb-6">üëë Math Arena Champions üëë</h2>
        <p id="yourScore" class="text-center text-xl font-bold mb-4 text-white"></p>
        <table id="leaderboardTable" class="leaderboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Hero Name</th>
                    <th>Level</th>
                    <th>Time (s)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Leaderboard data will be inserted here -->
            </tbody>
        </table>
        <p class="text-sm text-center text-gray-500 mt-4">üöß Under Construction ‚Äî The leaderboard will showcase the top completion times achieved by all players.</p>
    </div>

    <!-- Control Buttons -->
    <div class="flex justify-center mt-6">
        <button onclick="startGame()" id="startButton" class="attack-btn text-white font-bold py-3 px-8 rounded-xl text-lg uppercase tracking-wider">
            Start Battle
        </button>
        <button onclick="resetGame()" id="resetButton" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-xl text-lg uppercase tracking-wider ml-4">
            Start New Game
        </button>
    </div>

</div>

<script>
    // --- Global Configuration ---
    const MAX_HP_BASE = 100;
    const MAX_STREAK = 3;
    const TIME_PER_QUESTION = 20;
    const FAIL_DAMAGE_HP = 15;
    
    const MONSTERS = [
        { name: "The Error Beast", icon: 'üëπ' },
        { name: "The Number Nightmare", icon: 'üíÄ' },
        { name: "The Calculus Terror", icon: 'üëæ' },
        { name: "The Trigonometry Tyrant", icon: 'üêâ' },
        { name: "The Final Boss of Math", icon: 'üëë' }
    ];

	const HERO_CLASSES = [
		{
			id: 0,
			name: "Balanced Blade",
			emoji: "‚öîÔ∏è",
			baseDamage: 15,
			baseHP: 100,
			desc: "Born in a small village at the edge of the kingdom, the Balanced Blade always believed in fairness and courage. From a young age, he trained tirelessly with a wooden sword, dreaming of protecting the innocent and bringing peace to the land. When the mysterious Error Beast started causing chaos in the world of numbers, he took up his sword to restore balance and show that every problem, no matter how tricky, can be solved with a clear mind and a steady hand.",
			stats: [
				"HP: 100",
				"Damage: 15",
				"Special: None"
			]
		},
		{
			id: 1,
			name: "Tanky Titan",
			emoji: "üõ°Ô∏è",
			baseDamage: 12,
			baseHP: 115,
			desc: "The Tanky Titan hails from the mountains, a giant of a hero with a heart as strong as his shield. He has defended his village from countless dangers, learning that patience and protection are as important as power. When the Trigonometry Tyrant invaded the land, threatening the harmony of learning, he knew it was time to bring his mighty shield and defend the heroes who can solve any challenge. Nothing gets past his defenses!",
			stats: [
				"HP: 115",
				"Damage: 12",
				"Special: None"
			]
		},
		{
			id: 2,
			name: "Speedy Sorcerer",
			emoji: "üßô",
			baseDamage: 18,
			baseHP: 85,
			desc: "From the magical forests of Arithmia, the Speedy Sorcerer always loved experimenting with spells and discovering new ways to solve puzzles. Tiny in size but big in intellect, he zips across the battlefield, casting magic bolts that challenge even the trickiest of foes. When the Calculus Terror began spreading confusion, he raced to the battlefield to prove that brains and speed together can overcome any obstacle.",
			stats: [
				"HP: 85",
				"Damage: 18",
				"Special: None"
			]
		}
	];

    // --- NEW: Item Templates with Strategic Effects (12 Total) ---
    const ITEM_TEMPLATES = {
        // Base Items
        'HP_UP': { name: "Potion of Resilience", desc: "+25 Max HP & current HP healed.", icon: "üíñ" },
        'ATTACK_UP': { name: "Scroll of Power", desc: "+5 permanent Base Damage.", icon: "‚öîÔ∏è" },
        'FUNNY_FAIL': { name: "Amulet of Luck", desc: "Next failure deals 0 damage (1-time use).", icon: "üçÄ" },
        
        // New Strategic Items
        'TIME_BOOST': { name: "Clock of Haste", desc: "+5 seconds to the timer for the next 5 questions.", icon: "‚è±Ô∏è" },
        'WEAKEN_MONSTER': { name: "Vial of Acid", desc: "Monster takes +25% damage for the next 3 correct answers.", icon: "üß™" },
        'CRIT_CHANCE': { name: "Blade of Fortune", desc: "Next 3 hits have a 50% chance to be a 2x Critical Hit.", icon: "üî™" },
        'STREAK_PROTECT': { name: "Iron Will Band", desc: "Next incorrect answer does NOT break your streak.", icon: "üîó" },
        'TIMER_FREEZE': { name: "Hourglass of Stasis", desc: "The next question will have no timer (0 damage on fail).", icon: "‚è≥" },
        'SUPER_CHARGE': { name: "Essence of Fury", desc: "Your next correct answer is a guaranteed Super Attack (3x).", icon: "‚ö°" },
        'HP_DRAIN': { name: "Vampiric Touch", desc: "Next correct answer heals you for 50% of the damage dealt.", icon: "ü©∏" },
        'SHIELD_WALL': { name: "Paladin's Aegis", desc: "Monster's next 2 attacks deal 50% less damage.", icon: "üõ°Ô∏è" },
        'SKIP_QUESTION': { name: "Teleport Scroll", desc: "Allows skipping the next question with no penalty. (1-time use)", icon: "üåå" },
    };

    // --- Game State Variables ---
    let heroHP, heroMaxHP, monsterHP, monsterMaxHP, currentLevel;
    let currentQuestion = null;
    let consecutiveCorrect = 0;
    let battleNumber = 0; 
    let currentHeroClass = HERO_CLASSES[0];
    let timer = null; 
    let timerValue = TIME_PER_QUESTION; 
    let heroBaseDamage = HERO_CLASSES[0].baseDamage;
    let startTime = null; // NEW: Start time for the game
    let totalTimeSeconds = 0; // NEW: Total time in seconds

    // --- NEW: Item Effect States ---
    let funnyFailActive = false;
    let timeBoostRounds = 0;
    let weakenMonsterRounds = 0;
    let critChanceRounds = 0;
    let streakProtectActive = false;
    let timerFreezeRounds = 0;
    let superChargeActive = false;
    let hpDrainActive = false;
    let shieldWallRounds = 0;
    let skipQuestionActive = false;

    // --- DOM Elements ---
    const gameAppEl = document.getElementById('gameApp');
    const heroVisualContainerEl = document.getElementById('heroVisualContainer');
    const monsterVisualEl = document.getElementById('monsterVisual');
    const heroHealthEl = document.getElementById('heroHealth');
    const monsterHealthEl = document.getElementById('monsterHealth');
    const heroMaxHPDisplayEl = document.getElementById('heroMaxHPDisplay');
    const monsterCurrentHPDisplayEl = document.getElementById('monsterCurrentHPDisplay');
    const questionDisplayEl = document.getElementById('questionDisplay');
    const answerInputEl = document.getElementById('answerInput');
    const messageBoxEl = document.getElementById('messageBox');
    const startButtonEl = document.getElementById('startButton');
    const resetButtonEl = document.getElementById('resetButton');
    const gamePlayAreaEl = document.getElementById('gamePlayArea');
    const levelSelectEl = document.getElementById('level');
    const heroClassSelectEl = document.getElementById('heroClassSelect');
    const heroNameInputEl = document.getElementById('heroNameInput');
    const heroNameDisplayEl = document.getElementById('heroNameDisplay');
    const streakCountEl = document.getElementById('streakCount');
    const battleCountEl = document.getElementById('battleCount');
    const monsterNameEl = document.getElementById('monsterName');
    const timerBoxEl = document.getElementById('timerBox');
    const timerDisplayEl = document.getElementById('timerDisplay');
    const timerTitleEl = document.getElementById('timerTitle');
    const rewardAreaEl = document.getElementById('rewardArea');
    const leaderboardAreaEl = document.getElementById('leaderboardArea');
    const itemSelectionAreaEl = document.getElementById('itemSelectionArea');
    const configPanelEl = document.getElementById('configPanel');
    const skipButtonEl = document.getElementById('skipButton');
	
	const heroInfoBtn = document.getElementById('heroInfoBtn');
	const heroInfoModal = document.getElementById('heroInfoModal');
	const heroInfoClose = document.getElementById('heroInfoClose');
	const heroInfoTitle = document.getElementById('heroInfoTitle');
	const heroInfoDesc = document.getElementById('heroInfoDesc');
	const heroInfoStats = document.getElementById('heroInfoStats');
	const heroSelect = document.getElementById('heroClassSelect');

	heroInfoBtn.addEventListener('click', () => {
		const selectedHero = HERO_CLASSES[parseInt(heroSelect.value)];
		heroInfoTitle.textContent = `${selectedHero.emoji} ${selectedHero.name}`;
		heroInfoDesc.textContent = selectedHero.desc;
		heroInfoStats.innerHTML = "";
		selectedHero.stats.forEach(stat => {
			const li = document.createElement('li');
			li.textContent = stat;
			heroInfoStats.appendChild(li);
		});
		heroInfoModal.classList.remove('hidden');
	});

	heroInfoClose.addEventListener('click', () => {
		heroInfoModal.classList.add('hidden');
	});

    // --- Timer Logic ---
    function resetTimer() {
        if (timer) clearInterval(timer);
        timerValue = TIME_PER_QUESTION;
        timerDisplayEl.textContent = timerValue;
        timerBoxEl.classList.remove('text-red-300');
        timerBoxEl.classList.add('text-yellow-300');
        timerTitleEl.textContent = 'Time Left:';
    }

    function startTimer() {
        resetTimer();
        
        let currentTimerDuration = TIME_PER_QUESTION;
        
        if (timeBoostRounds > 0) {
            currentTimerDuration += 5; // +5 seconds boost
            timerTitleEl.textContent = 'Time Boost:';
            timeBoostRounds--;
        }
        
        if (timerFreezeRounds > 0) {
            timerBoxEl.classList.add('hidden');
            timerFreezeRounds--;
            return;
        } else {
            timerBoxEl.classList.remove('hidden');
        }
        
        timerValue = currentTimerDuration;
        timerDisplayEl.textContent = timerValue;

        timer = setInterval(() => {
            timerValue--;
            totalTimeSeconds++; // Increment total game time every second
            timerDisplayEl.textContent = timerValue;

            if (timerValue <= 5) {
                timerBoxEl.classList.remove('text-yellow-300');
                timerBoxEl.classList.add('text-red-300');
            }

            if (timerValue <= 0) {
                stopTimer();
                handleTimeOut();
            }
        }, 1000);
    }

    function stopTimer() {
        if (timer) clearInterval(timer);
        // Do not hide the box, just stop the timer
    }

    function handleTimeOut() {
        consecutiveCorrect = 0;
        
        let damage = FAIL_DAMAGE_HP;
        let message = `‚è±Ô∏è TIME OUT! ${heroNameDisplayEl.textContent} lost ${damage} HP for hesitating!`;
        
        // Apply funnyFailActive effect here if needed, but per original request, funnyFail only works on incorrect answers. 
        // For timeout, we follow the original design:
        heroHP = Math.max(0, heroHP - damage);

        messageBoxEl.className = 'message-box mb-4 text-red-400';
        messageBoxEl.innerHTML = `${message} The correct answer was ${currentQuestion.answer}.`;
        
        // Apply hero damage effect
        heroVisualContainerEl.classList.add('hero-damage-effect');
        updateStreakDisplay();
        updateHealthBars();

        setTimeout(() => {
            heroVisualContainerEl.classList.remove('hero-damage-effect');
            if (checkGameOver()) return;
            loadNextQuestion();
        }, 1500);
    }

    // --- Damage Calculation ---

    function getDamage(isHeroAttack, isSuper) {
        let baseDamage = isHeroAttack ? (isSuper ? heroBaseDamage * 3 : heroBaseDamage) : 15;
        
        const battleFactor = 1 + battleNumber * 0.2; 

        if (!isHeroAttack) {
            // Monster damage increases heavily
            const levelDamage = Math.floor(currentLevel / 3) * 2;
            baseDamage += (levelDamage * battleFactor) + (baseDamage * battleFactor);
            
            // Item: Shield Wall reduces monster damage
            if (shieldWallRounds > 0) {
                baseDamage *= 0.5;
                shieldWallRounds--;
                showMessage(`üõ°Ô∏è Shield Wall absorbed 50% of the monster's attack! ${shieldWallRounds} use(s) left.`, 'blue');
            }
        } else {
            // Hero damage
            baseDamage *= (1 / battleFactor);
        }

        return Math.round(baseDamage);
    }

    // --- Item Effect Helpers ---
    function decrementItemRounds() {
        // Decrement rounds for temporary buffs
        if (weakenMonsterRounds > 0) weakenMonsterRounds--;
        if (critChanceRounds > 0) critChanceRounds--;
    }

    // --- Game Logic ---

    function updateHealthBars() {
        const heroPercent = (heroHP / heroMaxHP) * 100;
        heroHealthEl.style.width = `${Math.max(0, heroPercent)}%`;
        heroHealthEl.style.backgroundColor = heroPercent > 50 ? '#48bb78' : heroPercent > 20 ? '#f6e05e' : '#f56565';
        heroMaxHPDisplayEl.textContent = heroMaxHP;

        const monsterPercent = (monsterHP / monsterMaxHP) * 100;
        monsterHealthEl.style.width = `${Math.max(0, monsterPercent)}%`;
        monsterHealthEl.style.backgroundColor = monsterPercent > 50 ? '#f56565' : monsterPercent > 20 ? '#f6ad55' : '#e53e3e';
        monsterCurrentHPDisplayEl.textContent = monsterHP;
    }

    function generateQuestion(level, battleNum) {
        // ... (Question generation logic remains the same, adjusted for LaTeX)
        let q = '', a = 0;
        const multiplier = 1 + battleNum * 0.15;
        let num1, num2;
		const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
		
        switch (parseInt(level)) {
			case 1: {
				const baseMax = 20;
				const maxValLevel1 = Math.floor(baseMax * multiplier);

				// Increase complexity based on battle number
				const difficulty = Math.min(battleNum, 5); // 1‚Äì5

				// Randomized modes that unlock gradually
				let modes = ["simple-add", "simple-sub"];

				if (difficulty >= 2) modes.push("bigger-add", "bigger-sub");
				if (difficulty >= 3) modes.push("three-add");
				if (difficulty >= 4) modes.push("mix-ops");

				const mode = modes[Math.floor(Math.random() * modes.length)];

				switch (mode) {

					// -------------------------------------
					case "simple-add":
						num1 = rand(5, maxValLevel1);
						num2 = rand(1, 10);
						q = `${num1} + ${num2} = ?`;
						a = num1 + num2;
						break;

					case "simple-sub":
						num1 = rand(5, maxValLevel1);
						num2 = rand(1, num1);
						q = `${num1} - ${num2} = ?`;
						a = num1 - num2;
						break;

					// -------------------------------------
					case "bigger-add": // unlocked battle >=2
						num1 = rand(10, maxValLevel1);
						num2 = rand(10, maxValLevel1);
						q = `${num1} + ${num2} = ?`;
						a = num1 + num2;
						break;

					case "bigger-sub":
						num1 = rand(15, maxValLevel1);
						num2 = rand(5, num1);
						q = `${num1} - ${num2} = ?`;
						a = num1 - num2;
						break;

					// -------------------------------------
					case "three-add": // unlocked battle >=3
						num1 = rand(5, maxValLevel1);
						num2 = rand(5, maxValLevel1);
						let num3 = rand(1, 10);
						q = `${num1} + ${num2} + ${num3} = ?`;
						a = num1 + num2 + num3;
						break;

					// -------------------------------------
					case "mix-ops": // unlocked battle >=4
						num1 = rand(5, maxValLevel1);
						num2 = rand(1, 10);
						let num4 = rand(1, 10);
						if (Math.random() < 0.5) {
							q = `${num1} + ${num2} - ${num4} = ?`;
							a = num1 + num2 - num4;
						} else {
							q = `${num1} - ${num2} + ${num4} = ?`;
							a = num1 - num2 + num4;
						}
						break;
				}
				break;
			}
            case 3: {
                const maxFactor = Math.floor(12 * multiplier);
                num1 = Math.floor(Math.random() * (maxFactor - 2)) + 2;
                num2 = Math.floor(Math.random() * (maxFactor - 2)) + 2;
				const product = num1 * num2;
				
				// Increase complexity based on battle number
				const difficulty = Math.min(battleNum, 5); // 1‚Äì5

				// Randomized modes that unlock gradually
				let modes = ["simple-multiplication"];

				if (difficulty >= 2) modes.push("simple-division");
				if (difficulty >= 3) modes.push("missing-factor");
				if (difficulty >= 4) modes.push("multi-step");
				
				const mode = modes[Math.floor(Math.random() * modes.length)];

				switch (mode) {

					// -------------------------------------
					case "simple-multiplication":
						q = `${num1} √ó ${num2} = ?`;
						a = product;
						break;
					
					// -------------------------------------
					case "simple-division":
						q = `${product} √∑ ${num1} = ?`;
						a = num2;
						break;
					
					// -------------------------------------
					case "missing-factor":
						if (Math.random() < 0.5) {
							// ? √ó num2 = product
							q = `? √ó ${num2} = ${product}`;
							a = num1;
						} else {
							// num1 √ó ? = product
							q = `${num1} √ó ? = ${product}`;
							a = num2;
						}
						break;
						
					// -------------------------------------
					case "multi-step":
						const addOrSub = Math.random() < 0.5 ? "+" : "-";
						const extra = Math.floor(Math.random() * 10) + 1;

						if (addOrSub === "+") {
							q = `${num1} √ó ${num2} + ${extra} = ?`;
							a = product + extra;
						} else {
							// Ensure no negative answers
							const safeExtra = Math.min(extra, product - 1);
							q = `${num1} √ó ${num2} - ${safeExtra} = ?`;
							a = product - safeExtra;
						}
						break;	
				}
                break;
			}
			case 6:
				if (Math.random() > 0.5) { 
					num1 = parseFloat((Math.random() * (10 * multiplier) + 1).toFixed(2));
					num2 = parseFloat((Math.random() * (5 * multiplier) + 1).toFixed(2));

					const exactSum = num1 + num2;
					a = parseFloat(exactSum.toFixed(1)); // Correct rounding to 1 decimal

					q = `Round to 1 decimal place: ${num1} + ${num2} = ?`;
				} else { 
					const denomMax = Math.floor(5 * multiplier) + 2; 
					const numMax   = Math.max(1, Math.floor(denomMax * 0.8));

					num1 = rand(2, denomMax);       // denominator
					num2 = rand(1, Math.min(numMax, num1 - 1));  // numerator < denominator

					const decimalValue = num2 / num1;
					a = parseFloat(decimalValue.toFixed(2)); // Always 2 decimals

					q = `Round to 2 decimal places: What is ${num2}/${num1} as a decimal?`;
				}
				break;
            case 9:
				const type = Math.floor(Math.random() * 6); // 0‚Äì5 patterns
				let xVal, A, B, C;

				switch (type) {
					// 0) ax + b = c
					case 0:
						A = Math.floor(Math.random() * 5) + 2; 
						B = Math.floor(Math.random() * 15) + 3; 
						xVal = Math.floor(Math.random() * 10) + 1;
						C = A * xVal + B;
						q = `Solve for x: ${A}x + ${B} = ${C}`;
						a = xVal;
						break;

					// 1) ax - b = c
					case 1:
						A = Math.floor(Math.random() * 5) + 2;
						B = Math.floor(Math.random() * 10) + 1;
						xVal = Math.floor(Math.random() * 10) + 1;
						C = A * xVal - B;
						q = `Solve for x: ${A}x - ${B} = ${C}`;
						a = xVal;
						break;

					// 2) b - ax = c
					case 2:
						A = Math.floor(Math.random() * 5) + 2;
						xVal = Math.floor(Math.random() * 10) + 1;
						B = A * xVal + (Math.floor(Math.random() * 10) + 3);
						C = B - A * xVal;
						q = `Solve for x: ${B} - ${A}x = ${C}`;
						a = xVal;
						break;

					// 3) (x + b)/a = c
					case 3:
						A = Math.floor(Math.random() * 4) + 2;
						B = Math.floor(Math.random() * 10) + 1;
						xVal = Math.floor(Math.random() * 10) + 1;
						C = (xVal + B) / A;
						q = `Solve for x: (x + ${B}) / ${A} = ${C}`;
						a = xVal;
						break;

					// 4) a(x - b) = c
					case 4:
						A = Math.floor(Math.random() * 4) + 2;
						B = Math.floor(Math.random() * 10) + 1;
						xVal = Math.floor(Math.random() * 10) + 1;
						C = A * (xVal - B);
						q = `Solve for x: ${A}(x - ${B}) = ${C}`;
						a = xVal;
						break;

					// 5) ax + bx = c  ‚Üí (a+b)x = c
					case 5:
						A = Math.floor(Math.random() * 4) + 1;
						B = Math.floor(Math.random() * 4) + 1;
						xVal = Math.floor(Math.random() * 10) + 1;
						C = (A + B) * xVal;
						q = `Solve for x: ${A}x + ${B}x = ${C}`;
						a = xVal;
						break;
				}

				break;

			case 12: {
				const types = ['trig-eval', 'trig-solve', 'derivative', 'multi-step'];
				const type = types[Math.floor(Math.random() * types.length)];

				switch(type) {

					// ----------------------
					case 'trig-eval':
						const trigVals = [
							{ q: 'sin(œÄ/6) = ?', a: 0.5 },
							{ q: 'cos(œÄ/3) = ?', a: 0.5 },
							{ q: 'tan(œÄ/4) = ?', a: 1 },
							{ q: 'sin(œÄ/2) = ?', a: 1 },
							{ q: 'cos(0) = ?', a: 1 }
						];
						const trigChoice = trigVals[Math.floor(Math.random() * trigVals.length)];
						q = trigChoice.q;
						a = trigChoice.a;
						break;

					// ----------------------
					case 'trig-solve':
						const angle = Math.floor(Math.random() * 5 + 1) * 10; // 10¬∞, 20¬∞, ..., 50¬∞
						if (Math.random() < 0.5) {
							q = `Solve for x: sin(x¬∞) = 0.5, 0 ‚â§ x ‚â§ 180`;
							a = [30, 150]; // degrees
						} else {
							q = `Solve for x: cos(x¬∞) = 0.5, 0 ‚â§ x ‚â§ 180`;
							a = [60, 300]; // degrees
						}
						break;

					// ----------------------
					case 'derivative':
						const xVal = Math.floor(Math.random() * 5) + 1;
						const derivTypes = ['x^2', '2x^3', '3x^2 + 2x', 'x*sin(x)', 'x^2*cos(x)'];
						const derivChoice = derivTypes[Math.floor(Math.random() * derivTypes.length)];

						if (derivChoice === 'x^2') {
							q = `Find f'(x) of f(x) = x^2 at x = ${xVal}`;
							a = 2 * xVal;
						} else if (derivChoice === '2x^3') {
							q = `Find f'(x) of f(x) = 2x^3 at x = ${xVal}`;
							a = 6 * (xVal ** 2);
						} else if (derivChoice === '3x^2 + 2x') {
							q = `Find f'(x) of f(x) = 3x^2 + 2x at x = ${xVal}`;
							a = 6 * xVal + 2;
						} else if (derivChoice === 'x*sin(x)') {
							q = `Find f'(x) of f(x) = x*sin(x) at x = ${xVal}`;
							a = Math.sin(xVal) + xVal * Math.cos(xVal); // approximate decimal
						} else if (derivChoice === 'x^2*cos(x)') {
							q = `Find f'(x) of f(x) = x^2*cos(x) at x = ${xVal}`;
							a = 2 * xVal * Math.cos(xVal) - xVal**2 * Math.sin(xVal); // approximate decimal
						}
						break;

					// ----------------------
					case 'multi-step':
						const n1 = Math.floor(Math.random() * 10) + 1;
						const n2 = Math.floor(Math.random() * 5) + 1;
						const ops = ['+', '-'];
						const op1 = ops[Math.floor(Math.random() * ops.length)];
						const op2 = ops[Math.floor(Math.random() * ops.length)];

						if (op1 === '+') {
							if (op2 === '+') {
								q = `${n1} * ${n2} + ${n1} + ${n2} = ?`;
								a = n1 * n2 + n1 + n2;
							} else {
								q = `${n1} * ${n2} + ${n1} - ${n2} = ?`;
								a = n1 * n2 + n1 - n2;
							}
						} else {
							if (op2 === '+') {
								q = `${n1} * ${n2} - ${n1} + ${n2} = ?`;
								a = n1 * n2 - n1 + n2;
							} else {
								q = `${n1} * ${n2} - ${n1} - ${n2} = ?`;
								a = n1 * n2 - n1 - n2;
							}
						}
						break;
				}
				break;
			}
        }

        if (level >= 6) { a = parseFloat(a.toFixed(2)); } else { a = Math.round(a); }
        return { question: q, answer: a };
    }

    function loadNextQuestion() {
        stopTimer();
        if (heroHP <= 0 || monsterHP <= 0) return;

        rewardAreaEl.classList.add('hidden');
        leaderboardAreaEl.classList.add('hidden');
        document.getElementById('battleArea').classList.remove('hidden');

        // Show skip button if active
        if (skipQuestionActive) {
            skipButtonEl.classList.remove('hidden');
        } else {
            skipButtonEl.classList.add('hidden');
        }

        currentQuestion = generateQuestion(currentLevel, battleNumber);
        questionDisplayEl.innerHTML = currentQuestion.question; // Use innerHTML for LaTeX
		MathJax.typesetPromise();   // <-- REQUIRED for LaTeX to show correctly
        answerInputEl.value = '';
        answerInputEl.focus();

        startTimer();
    }
    
    function skipQuestion() {
        if (!skipQuestionActive) return;

        stopTimer();
        skipQuestionActive = false;
        skipButtonEl.classList.add('hidden');
        
        showMessage(`üåå Question skipped! No penalty incurred.`, 'blue');
        
        setTimeout(() => {
            loadNextQuestion();
        }, 1000);
    }

    function checkAnswer() {
        if (!currentQuestion) return;
        stopTimer(); 

        const userAnswerStr = answerInputEl.value.trim();
        let userAnswer;

        if (currentLevel >= 6) {
            userAnswer = parseFloat(userAnswerStr);
            userAnswer = parseFloat(userAnswer.toFixed(2));
        } else {
            userAnswer = parseInt(userAnswerStr, 10);
        }

        const correctAnswer = currentQuestion.answer;
        const isCorrect = userAnswer === correctAnswer;

        if (isNaN(userAnswer) || userAnswerStr === '') {
            showMessage("Please enter a valid number for your answer!", 'yellow');
            startTimer(); 
            return;
        }

        answerInputEl.disabled = true;
        document.getElementById('submitButton').disabled = true;

        if (isCorrect) {
            handleCorrectAnswer();
        } else {
            handleIncorrectAnswer(correctAnswer);
        }
    }

	function triggerAnimation(el, className) {
		el.classList.remove(className);
		void el.offsetWidth; // Force reflow
		el.classList.add(className);
	}

    function handleCorrectAnswer() {
        consecutiveCorrect++;
        decrementItemRounds(); // Decrement timed effects
        
        let damageDealt = getDamage(true, false);
        let message = `‚úÖ Correct! ${heroNameDisplayEl.textContent} attacks ${monsterNameEl.textContent} for ${Math.round(damageDealt)} HP!`;
        let superEffect = false;

        // Item: Monster Weaken
        if (weakenMonsterRounds > 0) {
            damageDealt *= 1.25;
            message = `üß™ Vial of Acid effect! Damage boosted by 25% for ${weakenMonsterRounds} hit(s) left. Total: ${Math.round(damageDealt)} HP!`;
        }

        // Item: Crit Chance
        if (critChanceRounds > 0 && Math.random() < 0.5) {
            damageDealt *= 2; // 2x crit damage
            message = `üî™ CRITICAL HIT! Sharpening Stone bonus! Damage doubled! Total: ${Math.round(damageDealt)} HP!`;
        }

        // Item: Super Charge
        if (superChargeActive) {
            damageDealt = getDamage(true, true);
            message = `‚ö° ESSENCE OF FURY! Guaranteed Super Attack! ${monsterNameEl.textContent} takes ${Math.round(damageDealt)} HP!`;
            superChargeActive = false;
            superEffect = true;
        }
        
        // Check for natural Super Attack
        if (consecutiveCorrect >= MAX_STREAK && !superChargeActive) {
            damageDealt = getDamage(true, true);
            message = `üî• SUPER ATTACK! Three in a row! You blast ${monsterNameEl.textContent} for ${Math.round(damageDealt)} HP!`;
            consecutiveCorrect = 0;
            superEffect = true;
        }
        
        // Item: HP Drain
        if (hpDrainActive) {
            const healAmount = Math.round(damageDealt * 0.5);
            heroHP = Math.min(heroMaxHP, heroHP + healAmount);
            message += ` ü©∏ Vampiric Touch heals you for ${healAmount} HP!`;
            hpDrainActive = false;
        }

        // Apply visual effects
        if (superEffect) {
			triggerAnimation(gameAppEl, 'super-flash-effect');
			triggerAnimation(monsterVisualEl, 'shake-effect');
        }
		
		triggerAnimation(heroVisualContainerEl, 'hero-attack-effect');
		triggerAnimation(monsterVisualEl, 'monster-damage-effect');
		
        monsterHP = Math.max(0, monsterHP - Math.round(damageDealt));
        showMessage(message, 'green');
        updateStreakDisplay();
        updateHealthBars();
        
        setTimeout(() => {
            heroVisualContainerEl.classList.remove('hero-attack-effect');
            monsterVisualEl.classList.remove('monster-damage-effect');
            gameAppEl.classList.remove('super-flash-effect');
            monsterVisualEl.classList.remove('shake-effect');
            answerInputEl.disabled = false;
            document.getElementById('submitButton').disabled = false;
            if (checkGameOver()) return;
            loadNextQuestion();
        }, 800);
    }

    function handleIncorrectAnswer(correctAnswer) {
        let damageTaken = getDamage(false, false);
        let message = `‚ùå WRONG! The correct answer was ${correctAnswer}. `;

        // Item: Funny Fail / Amulet of Luck
        if (funnyFailActive) {
            damageTaken = 0;
            funnyFailActive = false;
            message += `The Amulet of Luck saved you! You take 0 damage.`;
        }
        
        // Item: Streak Protect
        let streakBroken = true;
        if (streakProtectActive) {
            streakBroken = false;
            streakProtectActive = false;
            message += `The Iron Will Band kept your streak intact!`;
        } else {
            consecutiveCorrect = 0;
        }
        
        // Take damage
        if (damageTaken > 0) {
            heroHP = Math.max(0, heroHP - damageTaken);
            message += `${monsterNameEl.textContent} strikes back, you lose ${damageTaken} HP!`;
        }

        showMessage(message, 'red');

        // Apply visual effects
		triggerAnimation(heroVisualContainerEl, 'hero-damage-effect');
		triggerAnimation(monsterVisualEl, 'monster-attack-effect');

        updateStreakDisplay();
        updateHealthBars();

        setTimeout(() => {
            monsterVisualEl.classList.remove('monster-attack-effect');
            heroVisualContainerEl.classList.remove('hero-damage-effect');
            answerInputEl.disabled = false;
            document.getElementById('submitButton').disabled = false;
            if (checkGameOver()) return;
            loadNextQuestion();
        }, 1000);
    }

    function updateStreakDisplay() {
        streakCountEl.textContent = `${consecutiveCorrect}`;
    }
    
    function updateBattleDisplay() {
        battleCountEl.textContent = `${battleNumber + 1}`;
        const monsterData = MONSTERS[battleNumber % MONSTERS.length];
        monsterNameEl.textContent = monsterData.name;
        monsterVisualEl.querySelector('span').textContent = monsterData.icon;
    }

    function showMessage(msg, color) {
        messageBoxEl.className = `message-box mb-4 text-${color}-400`;
        messageBoxEl.innerHTML = msg;
    }

    function checkGameOver() {
        if (heroHP <= 0) {
            showMessage(`GAME OVER! ${heroNameDisplayEl.textContent} has been defeated!`, 'red');
            endGame(false);
            return true;
        } else if (monsterHP <= 0) {
            showMessage(`VICTORY! ${monsterNameEl.textContent} has been vanquished!`, 'green');
            setTimeout(advanceBattleOrEndGame, 1500);
            return true;
        }
        return false;
    }

    function advanceBattleOrEndGame() {
        if (battleNumber + 1 >= MONSTERS.length) {
            // Final Boss Defeated!
            const endTime = performance.now();
            // Recalculate totalTimeSeconds based on performance timing for accuracy
            const totalTime = (endTime - startTime) / 1000; 
            
            showMessage(`CONGRATULATIONS! You defeated the Final Boss in ${totalTime.toFixed(2)} seconds!`, 'yellow');
            
            document.getElementById('yourScore').textContent = `Your Time (Level G${currentLevel}): ${totalTime.toFixed(2)} seconds`;
            endGame(true);
            
        } else {
            showRewardScreen();
        }
    }

    function showRewardScreen() {
        stopTimer();
        document.getElementById('battleArea').classList.add('hidden');
        gamePlayAreaEl.classList.add('hidden');
        leaderboardAreaEl.classList.add('hidden');
        rewardAreaEl.classList.remove('hidden');

        itemSelectionAreaEl.innerHTML = '';
        
        // Select 3 unique items randomly from the list of all keys
        const allItemKeys = Object.keys(ITEM_TEMPLATES);
        const shuffledKeys = allItemKeys.sort(() => 0.5 - Math.random());
        const selectedKeys = shuffledKeys.slice(0, 3);

        selectedKeys.forEach(itemKey => {
            const item = ITEM_TEMPLATES[itemKey];
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <p class="text-5xl mb-2">${item.icon}</p>
                <h3 class="text-xl font-bold text-blue-400 mb-2">${item.name}</h3>
                <p class="text-sm font-normal text-gray-400">${item.desc}</p>
            `;
            card.onclick = () => applyItemEffect(itemKey);
            itemSelectionAreaEl.appendChild(card);
        });
    }

    function applyItemEffect(itemKey) {
        // Disable all cards after selection
        Array.from(itemSelectionAreaEl.children).forEach(card => card.onclick = null);

        let message = '';

        switch (itemKey) {
            case 'HP_UP':
                heroMaxHP += 25;
                heroHP = Math.min(heroMaxHP, heroHP + 25);
                message = `You consumed the Potion of Resilience! Max HP increased to ${heroMaxHP} and you healed 25 HP.`;
                break;
            case 'ATTACK_UP':
                heroBaseDamage += 5;
                message = `You read the Scroll of Power! Base Damage increased by 5 to ${heroBaseDamage}.`;
                break;
            case 'FUNNY_FAIL':
                funnyFailActive = true;
                message = `You equipped the Amulet of Luck! Your next incorrect answer will deal 0 damage.`;
                break;
            case 'TIME_BOOST':
                timeBoostRounds = 5;
                message = `You activate the Clock of Haste! The next 5 questions have +5 seconds on the timer.`;
                break;
            case 'WEAKEN_MONSTER':
                weakenMonsterRounds = 3;
                message = `You threw the Vial of Acid! The monster will take +25% damage for the next 3 hits.`;
                break;
            case 'CRIT_CHANCE':
                critChanceRounds = 3;
                message = `You used the Sharpening Stone! Your next 3 hits have a 50% chance of a 2x Critical Hit.`;
                break;
            case 'STREAK_PROTECT':
                streakProtectActive = true;
                message = `You wear the Iron Will Band! Your next wrong answer will NOT break your streak.`;
                break;
            case 'TIMER_FREEZE':
                timerFreezeRounds = 1;
                message = `The Hourglass of Stasis is active! The next question has no timer.`;
                break;
            case 'SUPER_CHARGE':
                superChargeActive = true;
                message = `The Essence of Fury flows through you! Your next hit is a guaranteed Super Attack.`;
                break;
            case 'HP_DRAIN':
                hpDrainActive = true;
                message = `Vampiric Touch: Your next correct answer will heal you for 50% of the damage dealt.`;
                break;
            case 'SHIELD_WALL':
                shieldWallRounds = 2;
                message = `Paladin's Aegis deployed! Monster's next 2 attacks deal 50% less damage.`;
                break;
            case 'SKIP_QUESTION':
                skipQuestionActive = true;
                message = `You gained a Teleport Scroll! You can skip the next question with no penalty.`;
                break;
            default:
                message = "An unknown magic artifact was acquired.";
        }
        
        showMessage(`üéâ ${message}`, 'yellow');
        updateHealthBars();
        
        setTimeout(() => {
            // Advance to the next battle
            battleNumber++;
            consecutiveCorrect = 0;
            
            monsterMaxHP = Math.round(MAX_HP_BASE * (1 + battleNumber * 0.1)); 
            monsterHP = monsterMaxHP; 

            updateHealthBars();
            updateStreakDisplay();
            updateBattleDisplay();

            const monsterData = MONSTERS[battleNumber % MONSTERS.length];

            showMessage(`üéâ A new challenger appears: ${monsterData.name}! Monster Max HP: ${monsterMaxHP}!`, 'purple');
            
            document.getElementById('battleArea').classList.remove('hidden');
            rewardAreaEl.classList.add('hidden');
            gamePlayAreaEl.classList.remove('hidden');
            
            loadNextQuestion();
        }, 500);
    }

    function endGame(won) {
        stopTimer();
        gamePlayAreaEl.classList.add('hidden');
        rewardAreaEl.classList.add('hidden');
        startButtonEl.classList.add('hidden');
        configPanelEl.classList.add('hidden');
        resetButtonEl.classList.remove('hidden');
        skipButtonEl.classList.add('hidden');
        
        if (won) {
            document.getElementById('battleArea').classList.add('hidden');
            leaderboardAreaEl.classList.remove('hidden');
        } else {
            // If lost, keep battle area visible but hide controls
            leaderboardAreaEl.classList.add('hidden');
        }
    }

    // --- Game Control Functions ---

    function startGame() {
        if (!startTime) {
            startTime = performance.now(); // Start timer tracking
            totalTimeSeconds = 0;
        }
        
        // Set hero name and class
        const heroName = heroNameInputEl.value.trim() || "Math Warrior";
        heroNameDisplayEl.textContent = heroName;
        const classIndex = parseInt(heroClassSelectEl.value);
        currentHeroClass = HERO_CLASSES.find(c => c.id === classIndex) || HERO_CLASSES[0];
        document.getElementById('heroEmoji').textContent = currentHeroClass.emoji;
        
        currentLevel = levelSelectEl.value;
        heroMaxHP = currentHeroClass.baseHP;
        heroHP = heroMaxHP;
        heroBaseDamage = currentHeroClass.baseDamage; 

        monsterMaxHP = MAX_HP_BASE; 
        monsterHP = monsterMaxHP;
        
        consecutiveCorrect = 0;
        battleNumber = 0; 

        // Reset all item effects
        funnyFailActive = false;
        timeBoostRounds = 0;
        weakenMonsterRounds = 0;
        critChanceRounds = 0;
        streakProtectActive = false;
        timerFreezeRounds = 0;
        superChargeActive = false;
        hpDrainActive = false;
        shieldWallRounds = 0;
        skipQuestionActive = false;

        // Show/hide UI elements
        startButtonEl.classList.add('hidden');
        resetButtonEl.classList.add('hidden');
        configPanelEl.classList.remove('hidden');
        gamePlayAreaEl.classList.remove('hidden');
        rewardAreaEl.classList.add('hidden');
        leaderboardAreaEl.classList.add('hidden');
        document.getElementById('battleArea').classList.remove('hidden');

        // Reset display
        updateHealthBars();
        updateStreakDisplay();
        updateBattleDisplay();
        showMessage(`Level G${currentLevel} Battle START! Go ${heroName}, the ${currentHeroClass.name}!`, 'blue');

        setTimeout(loadNextQuestion, 1000);
    }

    function resetGame() {
        // Reset time tracking
        startTime = null; 
        totalTimeSeconds = 0;
        
        // Reset state
        heroHP = MAX_HP_BASE; heroMaxHP = MAX_HP_BASE; monsterHP = MAX_HP_BASE; monsterMaxHP = MAX_HP_BASE;
        consecutiveCorrect = 0; battleNumber = 0;

        // Reset item effects (redundant but safe)
        funnyFailActive = false; timeBoostRounds = 0; weakenMonsterRounds = 0; critChanceRounds = 0;
        streakProtectActive = false; timerFreezeRounds = 0; superChargeActive = false;
        hpDrainActive = false; shieldWallRounds = 0; skipQuestionActive = false;

        // UI Reset
        updateHealthBars();
        updateStreakDisplay();
        updateBattleDisplay();
        
        const classIndex = parseInt(heroClassSelectEl.value);
        currentHeroClass = HERO_CLASSES.find(c => c.id === classIndex) || HERO_CLASSES[0];
        document.getElementById('heroEmoji').textContent = currentHeroClass.emoji;
        heroNameDisplayEl.textContent = heroNameInputEl.value.trim() || "Math Warrior";

        showMessage("Enter your hero name, choose your class, select a level, and press 'Start Battle' to begin!", 'yellow');
        
        startButtonEl.classList.remove('hidden');
        resetButtonEl.classList.add('hidden');
        configPanelEl.classList.remove('hidden');
        gamePlayAreaEl.classList.add('hidden');
        rewardAreaEl.classList.add('hidden');
        leaderboardAreaEl.classList.add('hidden');
        skipButtonEl.classList.add('hidden');
        stopTimer();
    }

    // Initialize the game when the window loads
    window.onload = function() {
        const updateConfig = () => {
            const classIndex = parseInt(heroClassSelectEl.value);
            const selectedClass = HERO_CLASSES.find(c => c.id === classIndex) || HERO_CLASSES[0];
            document.getElementById('heroEmoji').textContent = selectedClass.emoji;
            heroNameDisplayEl.textContent = heroNameInputEl.value.trim() || "Math Warrior";
            
            if (!gamePlayAreaEl.classList.contains('hidden')) {
                resetGame();
            }
        };

        heroClassSelectEl.addEventListener('change', updateConfig);
        heroNameInputEl.addEventListener('input', updateConfig);
        levelSelectEl.addEventListener('change', updateConfig);

        updateConfig();
        updateHealthBars();
        updateBattleDisplay();
        
        resetGame(); 
    };
</script>

</body>
</html>
